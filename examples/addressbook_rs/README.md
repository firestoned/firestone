# Addressbook Rust Example

This directory contains a complete Rust implementation of the addressbook example, mirroring the Python setup in `examples/addressbook`.

## Structure

- `openapi.yaml` - **Auto-generated** OpenAPI specification from resource files (generated by firestone)
- `openapi.json` - JSON version of the OpenAPI spec (converted from YAML)
- `openapi-gen-config.json` - **NOT auto-generated** - Configuration for openapi-generator client generation
- `openapi-gen-server-config.json` - **NOT auto-generated** - Configuration for openapi-generator server generation (if used)
- `src/main.rs` - **NOT auto-generated** - Main entry point that combines CLI and server functionality
- `src/cli/` - **Auto-generated** CLI modules (generated by firestone)
- `src/apis/` - **Auto-generated** API client code (generated by openapi-generator from OpenAPI spec)
- `src/models/` - **Auto-generated** Data models (generated by openapi-generator from OpenAPI spec)
- `src/server/` - **NOT auto-generated** - Server implementation using axum (manually created)
- `Cargo.toml` - **NOT auto-generated** - Rust project configuration (manually created, combines dependencies)

## Generation

All code generation commands should be run from the firestone project root directory.

### Prerequisites

- `firestone` installed via Poetry (run `poetry install` in the project root)
- `openapi-generator` installed (e.g., via Homebrew: `brew install openapi-generator`)
- Resource files located in `examples/addressbook/`:
  - `addressbook.yaml`
  - `person.yaml`
  - `postal_codes.yaml`

**Note:** The `unset PYTHONPATH` command is important for Python 3.13+ compatibility when using Poetry.

### Step 1: Generate OpenAPI Specification

Generate the OpenAPI 3.1.0 specification from the resource files:

```bash
# From the firestone project root
cd /path/to/firestone
unset PYTHONPATH
poetry run firestone generate \
  --title 'Example person and addressbook API' \
  --description 'Example person and addressbook API' \
  --resources examples/addressbook/addressbook.yaml,examples/addressbook/person.yaml,examples/addressbook/postal_codes.yaml \
  --version 1.0 \
  openapi \
  --version 3.1.0 \
  > examples/addressbook_rs/openapi.yaml
```

This generates `examples/addressbook_rs/openapi.yaml`.

### Step 2: Generate Rust CLI Code

Generate the Rust Clap-based CLI modules:

```bash
# From the firestone project root
cd /path/to/firestone
unset PYTHONPATH
poetry run firestone generate \
  --title 'Addressbook CLI' \
  --description 'This is the CLI for the example Addressbook' \
  --resources examples/addressbook/addressbook.yaml,examples/addressbook/person.yaml,examples/addressbook/postal_codes.yaml \
  --version 1.0 \
  cli \
  --pkg addressbook_rs \
  --client-pkg 'addressbook_rs::apis' \
  --output-dir examples/addressbook_rs/src/cli \
  --as-modules \
  --language rust
```

**Note:** The `--client-pkg` value uses Rust module syntax (`addressbook_rs::apis`) and should be quoted.

This generates:

- `src/cli/addressbook.rs`
- `src/cli/persons.rs`
- `src/cli/postal_codes.rs`
- `src/cli/mod.rs`

### Step 3: Generate Rust API Client and Models

Generate the Rust API client code and models from the OpenAPI specification:

```bash
# From the addressbook_rs directory
cd examples/addressbook_rs

# Generate client code directly to project directory
openapi-generator generate \
  -i openapi.yaml \
  -g rust \
  -o . \
  --skip-validate-spec \
  -c openapi-gen-config.json

# Clean up generated files we don't need
rm -rf .openapi-generator .travis.yml git_push.sh .openapi-generator-ignore docs/ src/lib.rs Cargo.toml

# Note: The generated Cargo.toml is removed as we use our own manually created Cargo.toml
```

**Note:** The `openapi-generator` tool creates some metadata files (`.openapi-generator/`, `.travis.yml`, `git_push.sh`, etc.) that are not needed for the project. These are cleaned up in the command above and are already ignored via `.gitignore`.

**Important:** The generated `Cargo.toml` and `src/lib.rs` are removed as they conflict with our binary crate setup. We use our own manually created `Cargo.toml`.

This generates:

- `src/apis/*.rs` - API client functions
- `src/models/*.rs` - Data models

### Summary of Generated Files

**Auto-generated files:**

- `openapi.yaml` - OpenAPI specification (Step 1)
- `src/cli/*.rs` - CLI modules (Step 2)
- `src/apis/*.rs` - API client code (Step 3)
- `src/models/*.rs` - Data models (Step 3)

**Manually created files (marked with comments in the code):**

- `src/main.rs` - Combines CLI and server functionality
- `src/server/mod.rs` - Server implementation using axum
- `Cargo.toml` - Project dependencies (combines auto-generated and manual dependencies)
- `src/cli/mod.rs` - Module exports (may need manual updates if new resources are added)

## Usage

### Running the Server

Start the server on the default port (8080):

```bash
cd examples/addressbook_rs
cargo run -- --server
```

Or specify a custom port:

```bash
cargo run -- --server --port 3000
```

### Running CLI Commands

In a separate terminal, use the CLI commands:

```bash
cd examples/addressbook_rs

# List all addressbooks
cargo run -- addressbook list

# Create a new addressbook entry
cargo run -- addressbook create \
  --addrtype work \
  --city "San Francisco" \
  --country "USA" \
  --state "CA" \
  --street "123 Main St"

# Get a specific addressbook entry (replace <address_key> with actual key)
cargo run -- addressbook get <address_key>

# Update an addressbook entry
cargo run -- addressbook update <address_key> --city "New York"

# Delete an addressbook entry
cargo run -- addressbook delete <address_key>

# List all persons
cargo run -- persons list

# Create a person
cargo run -- persons create --name "John Doe" --age 30 --email "john@example.com"

# List all postal codes
cargo run -- postal-codes list

# Create a postal code
cargo run -- postal-codes create --code "94102" --city "San Francisco" --state "CA"
```

### CLI Options

```bash
# Use a different API URL
cargo run -- --api-url http://localhost:3000 addressbook list

# Set API key (if needed)
cargo run -- --api-key "your-key" addressbook list

# Enable debug logging
cargo run -- --debug addressbook list
```

### Environment Variables

You can also set these via environment variables:

```bash
export API_URL=http://localhost:8080
export API_KEY=your-key-here
cargo run -- addressbook list
```

### Getting Help

Get help for any command:

```bash
cargo run -- --help
cargo run -- addressbook --help
cargo run -- addressbook create --help
```

## Notes

In a production setup, the API client and server code would be fully generated from the OpenAPI specification using tools like `openapi-generator` or similar. The current implementation provides a basic structure that demonstrates how the CLI and server would work together.
